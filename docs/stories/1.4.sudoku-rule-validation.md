# Story 1.4: Sudoku Rule Validation

## Status

**Draft**

## Story

**As a** Sudoku player,
**I want** immediate visual feedback when I violate Sudoku rules,
**so that** I can identify and correct my mistakes during solving.

## Acceptance Criteria

1. When a number is entered, the application checks for duplicates in the same row
2. When a number is entered, the application checks for duplicates in the same column
3. When a number is entered, the application checks for duplicates in the same 3x3 box
4. If a violation is detected, the offending cell(s) are highlighted in red
5. Red highlighting applies to all cells in the conflict (both the newly entered cell and any existing conflicting cells)
6. Red highlighting is removed automatically when the conflict is resolved (by changing or clearing a number)
7. Validation runs in real-time as numbers are entered (no explicit "Check" button required for basic validation)
8. Given clue cells are included in validation checks but cannot themselves be highlighted as errors (since they're immutable)
9. Multiple simultaneous violations are all highlighted (e.g., if a number violates both row and column rules)

## Tasks / Subtasks

- [ ] Create validation module (scripts/validation.js) (AC: 1, 2, 3)
  - [ ] Create file with ES6 module exports
  - [ ] Implement `validateGrid(grid)` - returns Set of error cell coordinates
  - [ ] Implement `hasNoErrors(grid)` - returns boolean
  - [ ] Implement helper `getRowConflicts(grid, row, col, value)`
  - [ ] Implement helper `getColConflicts(grid, row, col, value)`
  - [ ] Implement helper `getBoxConflicts(grid, row, col, value)`

- [ ] Implement row validation logic (AC: 1, 5)
  - [ ] For each row, check for duplicate non-zero values
  - [ ] Return all cells with duplicates (including given clues)
  - [ ] Return cell coordinates as Set of "row,col" strings

- [ ] Implement column validation logic (AC: 2, 5)
  - [ ] For each column, check for duplicate non-zero values
  - [ ] Return all cells with duplicates
  - [ ] Return cell coordinates as Set of "row,col" strings

- [ ] Implement 3x3 box validation logic (AC: 3, 5)
  - [ ] For each 3x3 box, check for duplicate non-zero values
  - [ ] Calculate box coordinates: `boxRow = Math.floor(row/3)*3`, `boxCol = Math.floor(col/3)*3`
  - [ ] Return all cells with duplicates
  - [ ] Return cell coordinates as Set of "row,col" strings

- [ ] Update state module to track errors (AC: 4, 6, 7)
  - [ ] Add `errors` property: `Set<string>` of error cell coordinates
  - [ ] Implement `getErrors()` - returns error set
  - [ ] Implement `setErrors(errorSet)` - updates errors
  - [ ] Modify `setCellValue()` to trigger validation after each change
  - [ ] Modify `clearCell()` to trigger validation after clearing

- [ ] Update UI module to display errors (AC: 4, 6, 8)
  - [ ] Modify `renderCell()` to add 'error' class if cell in error set
  - [ ] Modify `renderGrid()` to pass errors parameter
  - [ ] Ensure 'error' class applies red styling
  - [ ] Ensure given-clue cells with errors still look like given clues (don't change to user-entry style)

- [ ] Integrate validation into main.js (AC: 7)
  - [ ] Import validation module
  - [ ] After `setCellValue()`, call `validation.validateGrid()`
  - [ ] After `clearCell()`, call `validation.validateGrid()`
  - [ ] Update state errors: `state.setErrors(errorSet)`
  - [ ] Re-render grid with new errors: `ui.renderGrid()`

- [ ] Update CSS for error highlighting (AC: 4)
  - [ ] `.cell.error`: Red background (e.g., #ffebee)
  - [ ] `.cell.error`: Red text color (e.g., #c62828)
  - [ ] Ensure error styling is visible over given-clue and user-entry styles

## Dev Notes

### Architecture Context

**Validation Module Design:**
- **Pure functions:** No side effects, just analyze grid and return errors
- **Performance:** Validation should complete within 100ms (NFR2)
- **Comprehensive:** Check ALL cells for conflicts, not just the changed cell

**Sudoku Rules:**
1. **Row Rule:** No duplicate numbers 1-9 in any row
2. **Column Rule:** No duplicate numbers 1-9 in any column
3. **Box Rule:** No duplicate numbers 1-9 in any 3x3 box

**Validation Algorithm:**
```javascript
export function validateGrid(grid) {
  const errors = new Set();

  // Check all rows
  for (let row = 0; row < 9; row++) {
    const seen = new Map(); // value -> [col1, col2, ...]
    for (let col = 0; col < 9; col++) {
      const value = grid[row][col];
      if (value !== 0) {
        if (!seen.has(value)) {
          seen.set(value, []);
        }
        seen.get(value).push(col);
      }
    }
    // Add all cells with duplicates to error set
    for (const [value, cols] of seen.entries()) {
      if (cols.length > 1) {
        cols.forEach(col => errors.add(`${row},${col}`));
      }
    }
  }

  // Check all columns (similar logic)
  // Check all 3x3 boxes (similar logic)

  return errors;
}
```

**3x3 Box Indexing:**
- Box 0: rows 0-2, cols 0-2
- Box 1: rows 0-2, cols 3-5
- Box 2: rows 0-2, cols 6-8
- Box 3: rows 3-5, cols 0-2
- ... and so on

**Box Calculation:**
```javascript
function getBoxStartCoords(row, col) {
  const boxRow = Math.floor(row / 3) * 3;
  const boxCol = Math.floor(col / 3) * 3;
  return { boxRow, boxCol };
}

// Iterate box:
for (let r = boxRow; r < boxRow + 3; r++) {
  for (let c = boxCol; c < boxCol + 3; c++) {
    // Check cell at grid[r][c]
  }
}
```

**Error Set Format:**
- Use Set of strings: `"row,col"`
- Example: `Set(["0,3", "0,5", "2,3"])` means errors at (0,3), (0,5), (2,3)
- Efficient lookup: `errors.has("0,3")`

**State Integration:**
```javascript
export function setCellValue(row, col, value) {
  if (!isGivenClue(row, col)) {
    grid[row][col] = value;

    // Trigger validation
    const errorSet = validation.validateGrid(grid);
    setErrors(errorSet);
  }
}
```

**UI Integration:**
```javascript
export function renderCell(row, col, value, isGiven, hasError) {
  const cell = document.createElement('div');
  cell.className = 'cell';
  cell.dataset.row = row;
  cell.dataset.col = col;

  if (isGiven) {
    cell.classList.add('given-clue');
  } else if (value !== 0) {
    cell.classList.add('user-entry');
  }

  if (hasError) {
    cell.classList.add('error');
  }

  if (value !== 0) {
    cell.textContent = value;
  }

  return cell;
}
```

**CSS Priority:**
- Error styling should be visible regardless of given-clue or user-entry classes
- Use sufficient specificity or `!important` if needed
- Example: `.cell.error` has red background, overrides other background colors

### Testing

**Testing Strategy:** Manual interaction testing with deliberate rule violations

**Test Checklist:**

1. **Row Validation (AC: 1, 4, 5):**
   - Find a row with empty cells
   - Enter a number that already exists in that row
   - Verify both cells (original and new) turn red
   - Change the new number to something else
   - Verify red highlighting clears

2. **Column Validation (AC: 2, 4, 5):**
   - Find a column with empty cells
   - Enter a number that already exists in that column
   - Verify both cells turn red
   - Clear the newly entered cell
   - Verify red highlighting clears

3. **Box Validation (AC: 3, 4, 5):**
   - Find a 3x3 box with empty cells
   - Enter a number that already exists in that box
   - Verify both cells turn red
   - Change to valid number
   - Verify red highlighting clears

4. **Multiple Violations (AC: 9):**
   - Enter a number that violates BOTH row and column
   - Verify all conflicting cells are red (could be 3+ cells)
   - Verify both row and column conflicts are highlighted

5. **Given Clue Handling (AC: 8):**
   - Enter a number that conflicts with a given clue
   - Verify the user-entered cell turns red
   - Verify the given clue cell does NOT change appearance (remains bold/gray)
   - Note: Given clue is included in conflict detection but not visually changed

6. **Real-time Validation (AC: 7):**
   - Verify errors appear immediately after typing (no button press needed)
   - Verify errors clear immediately when conflict resolved

7. **Performance:**
   - Enter numbers quickly in succession
   - Verify no lag or delay in highlighting (< 100ms)

**Expected Behavior:**
- Error highlighting is immediate (real-time)
- All conflicting cells are highlighted, not just the one you changed
- Clearing or changing the conflict removes red highlighting automatically

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation from PRD | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

*(To be filled by dev agent)*

### Debug Log References

*(To be filled by dev agent)*

### Completion Notes

*(To be filled by dev agent)*

### File List

*(To be filled by dev agent)*

## QA Results

*(To be filled by QA agent)*