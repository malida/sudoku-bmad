# Story 3.4: Difficulty Level Selection - Brownfield Addition

## Status

Ready for Development

## Story

**As a** Sudoku player,
**I want** to choose the difficulty level (Easy, Medium, Hard) for my puzzle,
**So that** I can play puzzles appropriate for my skill level.

## Story Context

**Existing System Integration:**

- Integrates with: `scripts/generator.js` (generatePuzzle function), `scripts/main.js` (handleNewPuzzle), `scripts/state.js` (state management), `index.html` (difficulty selector UI), `styles/sudoku.css` (difficulty selector styling)
- Technology: JavaScript ES6, HTML5 select/radio inputs, CSS3
- Follows pattern: Existing button handler pattern (handleNewPuzzle), existing state management pattern (state.js)
- Touch points:
  - `generator.generatePuzzle()` - Modify to accept difficulty parameter
  - `main.handleNewPuzzle()` - Read selected difficulty and pass to generator
  - `index.html` - Add difficulty selector UI
  - `state.js` - Store selected difficulty (optional, for persistence)

**Current Pain Point:**
All puzzles have ~45 clues (moderate difficulty). No way for beginners to get easier puzzles or experts to get harder puzzles. Single difficulty level limits audience reach.

## Acceptance Criteria

**Functional Requirements:**

1. Difficulty selector UI displays with three options: Easy, Medium, Hard
2. Difficulty selector positioned above or near "New Puzzle" button
3. Easy difficulty generates puzzles with ~50-55 given clues
4. Medium difficulty generates puzzles with ~40-45 given clues (current default)
5. Hard difficulty generates puzzles with ~30-35 given clues
6. Selected difficulty persists during session (doesn't reset on puzzle generation)
7. Default difficulty is Medium on first load
8. Clicking "New Puzzle" uses currently selected difficulty

**Integration Requirements:**

9. `generatePuzzle()` function accepts optional difficulty parameter ('easy'|'medium'|'hard')
10. Existing `generatePuzzle()` calls with no parameter default to 'medium'
11. Puzzle generation performance remains <2 seconds for all difficulties
12. All existing validation, rendering, and gameplay logic unchanged
13. Generator ensures unique solution for all difficulty levels

**Quality Requirements:**

14. Difficulty selector follows existing design system (colors, spacing, styling)
15. Difficulty selector is touch-friendly on mobile (44x44px minimum)
16. Generated puzzles remain solvable and have unique solutions
17. No console errors
18. Code follows existing patterns in generator.js and main.js

## Technical Notes

**Integration Approach:**

1. **Generator Changes (scripts/generator.js):**
   - Modify `generatePuzzle()` signature: `export function generatePuzzle(difficulty = 'medium')`
   - Add difficulty-to-clues mapping:
     ```javascript
     const CLUE_COUNTS = {
       easy: 55,    // More clues = easier
       medium: 45,  // Current default
       hard: 30     // Fewer clues = harder
     };
     const TARGET_CLUES = CLUE_COUNTS[difficulty] || CLUE_COUNTS.medium;
     ```
   - Rest of generation logic remains unchanged

2. **HTML Changes (index.html):**
   - Add difficulty selector above controls:
     ```html
     <div class="difficulty-selector">
       <label for="difficulty">Difficulty:</label>
       <select id="difficulty" class="difficulty-select">
         <option value="easy">Easy</option>
         <option value="medium" selected>Medium</option>
         <option value="hard">Hard</option>
       </select>
     </div>
     ```

3. **CSS Changes (styles/sudoku.css):**
   - Style `.difficulty-selector` (flexbox, centered, spacing)
   - Style `.difficulty-select` (follows existing button styling, touch-friendly)
   - Mobile-optimized sizing (minimum 44px height)

4. **JavaScript Changes (scripts/main.js):**
   - Modify `handleNewPuzzle()`:
     ```javascript
     const difficulty = document.getElementById('difficulty').value;
     const newPuzzle = generator.generatePuzzle(difficulty);
     ```
   - Modify `loadPuzzleOnInit()` similarly:
     ```javascript
     const difficulty = document.getElementById('difficulty')?.value || 'medium';
     const puzzle = generator.generatePuzzle(difficulty);
     ```

5. **State Management (Optional):**
   - Could store difficulty in state.js for future persistence
   - Not required for MVP (session-level persistence via select element is sufficient)

**Existing Pattern Reference:**
- `generator.generatePuzzle()` at scripts/generator.js:272
- `handleNewPuzzle()` at scripts/main.js:135-158
- Existing button styling in sudoku.css

**Key Constraints:**
- Must maintain <2 second generation time (NFR1)
- Must ensure unique solution for all difficulties
- Must follow existing code patterns
- Must work on desktop and mobile

## Definition of Done

- [x] Difficulty selector UI added to HTML
- [x] Difficulty selector styled consistently with design system
- [x] generatePuzzle() accepts difficulty parameter
- [x] Easy difficulty generates ~50-55 clue puzzles
- [x] Medium difficulty generates ~40-45 clue puzzles (current)
- [x] Hard difficulty generates ~30-35 clue puzzles
- [x] Selected difficulty persists during session
- [x] Default difficulty is Medium
- [x] "New Puzzle" button uses selected difficulty
- [x] All puzzles have unique solutions
- [x] Generation time <2 seconds for all difficulties
- [x] Existing functionality unchanged
- [x] Code follows existing patterns
- [x] No console errors
- [x] Tested on desktop and mobile

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** Hard difficulty (30 clues) may exceed 2-second generation time or produce unsolvable puzzles
- **Mitigation:** Test generation thoroughly, adjust clue counts if needed (Easy: 52, Medium: 45, Hard: 35), implement timeout handling
- **Rollback:** Revert generator.js, main.js, index.html, and sudoku.css changes; remove difficulty selector

**Compatibility Verification:**

- [x] No breaking changes to existing APIs (generatePuzzle accepts optional parameter with default)
- [x] No database changes (client-side only)
- [x] UI changes follow existing design patterns (select follows button styling)
- [x] Performance impact within acceptable range (generation time already <2s)

## Validation Checklist

**Scope Validation:**

- [x] Story can be completed in one development session (3-5 hours)
- [x] Integration approach is straightforward (parameter addition, UI control)
- [x] Follows existing patterns (button handlers, generator patterns)
- [x] No architecture work required (extends existing generator logic)

**Clarity Check:**

- [x] Story requirements are unambiguous (specific clue counts, difficulty names)
- [x] Integration points are clearly specified (generator.js, main.js, index.html, sudoku.css)
- [x] Success criteria are testable (clue counts, generation time, functionality)
- [x] Rollback approach is simple (revert file changes)

## Dev Notes

### Architecture Context

**Depends on:**
- Story 2.4 (MVP completion) - generator must be working
- Story 3.1 (On-Screen Number Pad) - UI must accommodate difficulty selector

**File Locations:**

Files to modify:
- `scripts/generator.js` - Add difficulty parameter to generatePuzzle()
- `scripts/main.js` - Read difficulty selector and pass to generator
- `index.html` - Add difficulty selector UI
- `styles/sudoku.css` - Style difficulty selector

Files to leave unchanged (integration only):
- `scripts/state.js` - No state changes needed (select element maintains value)
- `scripts/validation.js` - No validation changes
- `scripts/ui.js` - No UI rendering changes

### Testing

**Testing Strategy:** Manual testing with focus on puzzle generation across all difficulty levels

**Manual Test Checklist:**

1. **UI Display:**
   - Verify difficulty selector renders above controls
   - Verify three options present: Easy, Medium, Hard
   - Verify Medium is selected by default
   - Verify selector follows design system styling
   - Verify selector is touch-friendly (44px height minimum) on mobile

2. **Easy Difficulty:**
   - Select Easy from dropdown
   - Click "New Puzzle"
   - Count given clues (should be 50-55)
   - Verify puzzle is solvable
   - Repeat 3-5 times to ensure consistency

3. **Medium Difficulty:**
   - Select Medium from dropdown
   - Click "New Puzzle"
   - Count given clues (should be 40-45)
   - Verify puzzle is solvable
   - Repeat 3-5 times

4. **Hard Difficulty:**
   - Select Hard from dropdown
   - Click "New Puzzle"
   - Count given clues (should be 30-35)
   - Verify puzzle is solvable
   - Verify generation time <2 seconds
   - Repeat 3-5 times

5. **Difficulty Persistence:**
   - Select Hard
   - Click "New Puzzle"
   - Verify dropdown still shows Hard (not reset to Medium)
   - Click "New Puzzle" again
   - Verify another Hard puzzle generated

6. **Default Difficulty:**
   - Refresh page
   - Verify Medium is selected
   - Verify first puzzle is Medium difficulty (~40-45 clues)

7. **Existing Functionality (No Regression):**
   - Verify cell selection works
   - Verify number pad works
   - Verify keyboard input works
   - Verify validation works (red highlighting)
   - Verify "Check Solution" works
   - Complete a puzzle on each difficulty level

8. **Performance:**
   - Generate 10 Hard puzzles
   - Verify all complete within 2 seconds
   - If any timeout, adjust Hard difficulty to 35 clues and retest

9. **Mobile Testing:**
   - Test difficulty selector on mobile
   - Verify dropdown is tappable and usable
   - Verify no layout issues
   - Test on iOS Safari and Android Chrome

**Expected Behaviors:**
- Difficulty selector easy to understand and use
- Easy puzzles have more clues (easier to solve)
- Hard puzzles have fewer clues (more challenging)
- All puzzles remain solvable with unique solutions
- Generation time remains fast

**Pass Criteria:**
- All three difficulty levels generate appropriate puzzles
- Clue counts match specifications (Â±2 clues acceptable)
- Generation time <2 seconds for all difficulties
- Difficulty persists during session
- No regressions in existing functionality
- No console errors

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 1.0 | Difficulty level story created for mobile UX enhancement | Product Owner Sarah |

## Dev Agent Record

*(To be filled by Dev agent during implementation)*

## QA Results

*(To be filled by QA agent after implementation)*
