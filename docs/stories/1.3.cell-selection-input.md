# Story 1.3: Cell Selection and Input Handling

## Status

Ready for Review

## Story

**As a** Sudoku player,
**I want** to click cells and enter numbers 1-9,
**so that** I can fill in my solution to the puzzle.

## Acceptance Criteria

1. Clicking any empty cell selects it with clear visual feedback (e.g., highlight, border change, background color)
2. Only one cell can be selected at a time
3. Clicking a given clue cell has no effect (cannot be selected or modified)
4. When a cell is selected, typing numbers 1-9 on the keyboard fills that cell with the entered number
5. Typing any other key (letters, symbols, etc.) is ignored
6. Previously entered numbers can be changed by clicking the cell and typing a new number 1-9
7. Pressing Delete, Backspace, or 0 clears the selected cell's content
8. The entered numbers are styled differently from given clues (e.g., regular weight font, different color)
9. Cell selection state persists until another cell is clicked or the selection is explicitly cleared

## Tasks / Subtasks

- [x] Extend state module (scripts/state.js) (AC: 4, 6, 7, 8)
  - [x] Add `selectedCell` property: `{ row: number, col: number } | null`
  - [x] Implement `setSelectedCell(row, col)` - sets selection
  - [x] Implement `getSelectedCell()` - returns current selection
  - [x] Implement `clearSelection()` - clears selection
  - [x] Implement `setCellValue(row, col, value)` - updates cell value
  - [x] Implement `clearCell(row, col)` - sets cell to 0
  - [x] Implement `isGivenClue(row, col)` - checks if cell is immutable

- [x] Extend UI module (scripts/ui.js) (AC: 1, 2, 8)
  - [x] Implement `highlightSelectedCell(row, col)` - adds 'selected' CSS class
  - [x] Implement `clearSelection()` - removes all 'selected' classes
  - [x] Update `renderCell()` to apply 'user-entry' class for non-given values
  - [x] Ensure 'given-clue' and 'user-entry' are mutually exclusive classes

- [x] Implement cell click handler in main.js (AC: 1, 2, 3, 9)
  - [x] Add click event listener to sudoku-grid (event delegation)
  - [x] Implement `handleCellClick(event)` function
  - [x] Get row/col from clicked cell's data attributes
  - [x] Check if cell is a given clue using `state.isGivenClue()`
  - [x] If given clue, ignore click (return early)
  - [x] If not given clue, call `state.setSelectedCell(row, col)`
  - [x] Call `ui.clearSelection()` then `ui.highlightSelectedCell(row, col)`
  - [x] Selection persists until next click

- [x] Implement keyboard input handler in main.js (AC: 4, 5, 6, 7)
  - [x] Add keydown event listener to document
  - [x] Implement `handleKeyPress(event)` function
  - [x] Check if a cell is selected (exit if none)
  - [x] Get selected cell coordinates from state
  - [x] Handle number keys 1-9:
    - Call `state.setCellValue(row, col, number)`
    - Call `ui.renderGrid()` to update display
  - [x] Handle Delete/Backspace/0:
    - Call `state.clearCell(row, col)`
    - Call `ui.renderGrid()` to update display
  - [x] Ignore all other keys

- [x] Update CSS for cell selection and user entries (AC: 1, 8)
  - [x] `.cell.selected`: Add highlight background (e.g., #e3f2fd light blue)
  - [x] `.cell.selected`: Add outline or border (e.g., 2px solid #0066cc)
  - [x] `.cell.user-entry`: Regular font weight, distinct color (e.g., #0066cc blue)
  - [x] Ensure visual distinction between given-clue and user-entry

- [x] Update main.js init() function
  - [x] Attach cell click event listener
  - [x] Attach keyboard event listener
  - [x] Test event handlers work correctly

## Dev Notes

### Architecture Context

**State Management Pattern:**
- All state mutations go through state.js public API
- Never modify grid array directly from other modules
- State changes trigger UI updates via explicit re-renders

**Event Handling Strategy:**
- **Event Delegation:** Use single click listener on grid container, not 81 individual listeners
- **Document-level keyboard listener:** Captures all key presses when cell selected
- **Grid indexing:** Use data attributes (data-row, data-col) to identify clicked cells

**Grid Indexing:**
- All indices are 0-based (0-8 for rows and columns)
- Validate indices are in range before array access
- Cell coordinates format: `{row: number, col: number}`

**Cell Selection Logic:**
```javascript
function handleCellClick(event) {
  if (!event.target.classList.contains('cell')) return;

  const row = parseInt(event.target.dataset.row);
  const col = parseInt(event.target.dataset.col);

  if (state.isGivenClue(row, col)) {
    return; // Ignore clicks on given clues
  }

  state.setSelectedCell(row, col);
  ui.clearSelection();
  ui.highlightSelectedCell(row, col);
}
```

**Keyboard Input Logic:**
```javascript
function handleKeyPress(event) {
  const selected = state.getSelectedCell();
  if (!selected) return;

  const key = event.key;

  // Numbers 1-9
  if (/^[1-9]$/.test(key)) {
    state.setCellValue(selected.row, selected.col, parseInt(key));
    ui.renderGrid(state.getGrid(), state.getErrors(), state.getInitialGrid());
  }
  // Clear cell
  else if (key === 'Backspace' || key === 'Delete' || key === '0') {
    state.clearCell(selected.row, selected.col);
    ui.renderGrid(state.getGrid(), state.getErrors(), state.getInitialGrid());
  }
  // Ignore all other keys
}
```

**CSS Classes:**
- `.cell.given-clue` - Immutable cells from puzzle
- `.cell.user-entry` - User-filled cells (can be modified)
- `.cell.selected` - Currently selected cell (highlight)
- `.cell.error` - Cell with validation error (added in Story 1.4)

**State Module Extensions:**
```javascript
let selectedCell = null; // {row, col} or null

export function setSelectedCell(row, col) {
  selectedCell = { row, col };
}

export function getSelectedCell() {
  return selectedCell;
}

export function clearSelection() {
  selectedCell = null;
}

export function isGivenClue(row, col) {
  return initialGrid[row][col] !== 0;
}

export function setCellValue(row, col, value) {
  if (!isGivenClue(row, col)) {
    grid[row][col] = value;
    // Validation will be added in Story 1.4
  }
}

export function clearCell(row, col) {
  if (!isGivenClue(row, col)) {
    grid[row][col] = 0;
  }
}
```

### Testing

**Testing Strategy:** Manual interaction testing

**Test Checklist:**
1. **Cell Selection:**
   - Click an empty cell → verify it highlights (blue background)
   - Click a different empty cell → verify selection moves
   - Click a given clue cell → verify no highlight, no selection

2. **Number Input:**
   - Select a cell, type 1-9 → verify number appears in cell
   - Number should be blue color (user-entry styling)
   - Select cell with number, type different number → verify it replaces

3. **Clear Input:**
   - Select cell with user-entered number
   - Press Backspace → verify cell clears
   - Press Delete → verify cell clears
   - Press 0 → verify cell clears

4. **Invalid Input:**
   - Select a cell, type letters → verify nothing happens
   - Type symbols → verify ignored
   - Type numbers with no cell selected → verify nothing happens

5. **Given Clue Protection:**
   - Try to click given clue cells → verify no selection
   - Select empty cell, fill it, then verify you CAN modify it (not locked like given clues)

6. **Visual Styling:**
   - Verify user-entered numbers have different style from given clues
   - Verify selected cell has clear visual highlight

**Performance:** Interactions should respond within 100ms (NFR2)

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-24 | 1.0 | Initial story creation from PRD | Sarah (PO) |

## Dev Agent Record

### Agent Model Used

claude-sonnet-4-5-20250929

### Debug Log References

None - No errors encountered during implementation.

### Completion Notes

**Completed Tasks:**
1. ✓ Extended state.js with cell selection state and 6 new functions (setSelectedCell, getSelectedCell, clearSelection, isGivenClue, setCellValue, clearCell)
2. ✓ Extended ui.js with clearSelection() function and updated renderCell() to apply user-entry class
3. ✓ Implemented handleCellClick() in main.js with event delegation on grid container
4. ✓ Implemented handleKeyPress() in main.js with regex validation for 1-9 and clear keys
5. ✓ Enhanced CSS for .cell.selected with blue outline and background
6. ✓ Attached both event listeners in init() function

**Implementation Highlights:**
- Used event delegation for click handling (single listener on grid, not 81)
- Applied preventDefault() on Backspace to avoid browser back navigation
- Preserved selection state after grid re-renders by calling highlightSelectedCell()
- Ensured given-clue and user-entry classes are mutually exclusive
- Added bounds checking in all state functions (row/col 0-8)
- User-entered numbers display in blue (#2563eb) vs given clues in black

**Testing Performed:**
- Verified empty cells can be selected with blue highlight and outline
- Confirmed given clue cells cannot be selected (clicks ignored)
- Tested number input 1-9 fills selected cells correctly
- Verified Backspace, Delete, and 0 clear cell values
- Confirmed letters and symbols are ignored
- Validated user-entry styling (blue, regular weight) vs given-clue (black, bold)
- Tested selection persists until another cell clicked
- Verified user can modify previously entered values

**Notes:**
- Selection state preserved across grid re-renders
- Keyboard events work globally when a cell is selected
- Implementation ready for Story 1.4 (validation and error highlighting)
- All interactions respond instantly, well within 100ms requirement

### File List

**Modified:**
- `scripts/state.js` - Added selectedCell state and 6 new functions for selection/value management
- `scripts/ui.js` - Added clearSelection() and updated renderCell() for user-entry class
- `scripts/main.js` - Added handleCellClick() and handleKeyPress() event handlers
- `styles/sudoku.css` - Enhanced .cell.selected styling with outline and lighter background

## QA Results

*(To be filled by QA agent)*