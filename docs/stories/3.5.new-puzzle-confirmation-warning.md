# Story 3.5: New Puzzle Confirmation Warning - Brownfield Addition

## Status

Ready for Development

## Story

**As a** Sudoku player,
**I want** a confirmation warning before losing my in-progress puzzle,
**So that** I don't accidentally lose my work by clicking "New Puzzle".

## Story Context

**Existing System Integration:**

- Integrates with: `scripts/main.js` (handleNewPuzzle function), `scripts/state.js` (puzzle state checking), `scripts/ui.js` (potential message display)
- Technology: JavaScript ES6, native browser `confirm()` dialog or custom modal
- Follows pattern: Existing state checking pattern (isGridComplete), existing button handler pattern
- Touch points:
  - `main.handleNewPuzzle()` - Add confirmation check before generating
  - `state.isGridComplete()` - Check if puzzle is finished
  - `state.getGrid()` and `state.getInitialGrid()` - Check if user has made entries
  - Browser `confirm()` or custom confirmation dialog

**Current Pain Point:**
Users can accidentally click "New Puzzle" and lose their in-progress work without warning. This is frustrating, especially on mobile where accidental taps are common.

## Acceptance Criteria

**Functional Requirements:**

1. When "New Puzzle" is clicked, check if puzzle is in progress (has user entries AND not complete)
2. If puzzle is empty (no user entries), generate new puzzle immediately (no warning)
3. If puzzle is complete, generate new puzzle immediately (no warning)
4. If puzzle is in progress, show confirmation dialog: "Current puzzle will be lost. Start new puzzle?"
5. Confirmation dialog has two options: "Cancel" (keeps current puzzle) and "OK"/"Yes" (generates new puzzle)
6. Clicking Cancel/No closes dialog and returns to current puzzle
7. Clicking OK/Yes closes dialog and generates new puzzle
8. Confirmation works on both desktop and mobile

**Integration Requirements:**

9. Existing "New Puzzle" functionality unchanged when no confirmation needed
10. New puzzle generation follows existing pattern (difficulty selection, generation, rendering)
11. No changes to grid, validation, or input handling
12. Uses native browser `confirm()` for simplicity (no custom modal for MVP)

**Quality Requirements:**

13. Confirmation logic is clear and maintainable
14. No edge cases where user can lose progress without warning
15. Confirmation dialog text is clear and concise
16. No console errors
17. Code follows existing patterns in main.js

## Technical Notes

**Integration Approach:**

1. **State Checking Logic:**
   - Create helper function to check if puzzle is in progress:
     ```javascript
     function isPuzzleInProgress() {
       const grid = state.getGrid();
       const initialGrid = state.getInitialGrid();

       // Check if user has made any entries
       let hasUserEntries = false;
       for (let row = 0; row < 9; row++) {
         for (let col = 0; col < 9; col++) {
           if (grid[row][col] !== 0 && initialGrid[row][col] === 0) {
             hasUserEntries = true;
             break;
           }
         }
         if (hasUserEntries) break;
       }

       // In progress if has entries AND not complete
       return hasUserEntries && !state.isGridComplete();
     }
     ```

2. **Modify handleNewPuzzle (scripts/main.js):**
   ```javascript
   function handleNewPuzzle() {
     // Check if puzzle is in progress
     if (isPuzzleInProgress()) {
       // Show confirmation
       const confirmed = confirm('Current puzzle will be lost. Start new puzzle?');
       if (!confirmed) {
         return; // User cancelled, do nothing
       }
     }

     // Existing new puzzle logic...
     ui.showMessage('Generating puzzle...', 'info');
     // ... rest of existing code
   }
   ```

3. **No HTML/CSS Changes:**
   - Use native browser `confirm()` dialog (no custom UI needed for MVP)
   - If custom modal desired in future, can be added in follow-up story

**Existing Pattern Reference:**
- `handleNewPuzzle()` at scripts/main.js:135-158
- `isGridComplete()` at scripts/state.js:147-156
- State checking patterns in state.js

**Key Constraints:**
- Must not interfere with normal new puzzle flow when no warning needed
- Must work reliably on desktop and mobile browsers
- Native `confirm()` styling varies by browser (acceptable for MVP)
- Must check both user entries AND completion status

## Definition of Done

- [x] Helper function checks if puzzle is in progress
- [x] "New Puzzle" checks for in-progress puzzle before generating
- [x] Empty puzzle generates immediately (no warning)
- [x] Complete puzzle generates immediately (no warning)
- [x] In-progress puzzle shows confirmation dialog
- [x] Confirmation dialog text is clear
- [x] Cancel keeps current puzzle
- [x] OK generates new puzzle
- [x] Confirmation works on desktop and mobile
- [x] Existing functionality unchanged
- [x] Code follows existing patterns
- [x] No console errors

## Risk and Compatibility Check

**Minimal Risk Assessment:**

- **Primary Risk:** False positives/negatives in detecting in-progress puzzles
- **Mitigation:** Thorough testing of edge cases (empty grid, one entry, completed puzzle, partial puzzle)
- **Rollback:** Revert handleNewPuzzle() changes in main.js, remove helper function

**Compatibility Verification:**

- [x] No breaking changes to existing APIs (adds logic to existing function)
- [x] No database changes (client-side only)
- [x] No UI changes (uses native confirm dialog)
- [x] Performance impact is negligible (simple loop check)

## Validation Checklist

**Scope Validation:**

- [x] Story can be completed in one development session (1-2 hours)
- [x] Integration approach is straightforward (add confirmation check)
- [x] Follows existing patterns (state checking, button handler)
- [x] No design or architecture work required (simple guard clause)

**Clarity Check:**

- [x] Story requirements are unambiguous (specific confirmation conditions)
- [x] Integration points are clearly specified (handleNewPuzzle, state functions)
- [x] Success criteria are testable (test empty, in-progress, complete states)
- [x] Rollback approach is simple (revert main.js changes)

## Dev Notes

### Architecture Context

**Depends on:**
- Story 2.4 (MVP completion) - new puzzle functionality must exist
- Story 3.1 (On-Screen Number Pad) - user input method must exist

**File Locations:**

Files to modify:
- `scripts/main.js` - Add isPuzzleInProgress() helper, modify handleNewPuzzle()

Files to leave unchanged (integration only):
- `scripts/state.js` - Use existing getGrid(), getInitialGrid(), isGridComplete()
- `scripts/ui.js` - No UI changes (uses native confirm)
- `index.html` - No HTML changes
- `styles/sudoku.css` - No CSS changes

### Testing

**Testing Strategy:** Manual testing of all puzzle states (empty, in-progress, complete)

**Manual Test Checklist:**

1. **Empty Puzzle (No Warning Expected):**
   - Load application (new puzzle generated automatically)
   - Immediately click "New Puzzle" WITHOUT making any entries
   - Verify NO confirmation dialog appears
   - Verify new puzzle generates immediately

2. **Single Entry (Warning Expected):**
   - Load application
   - Click one cell and enter one number
   - Click "New Puzzle"
   - Verify confirmation dialog appears: "Current puzzle will be lost. Start new puzzle?"
   - Click Cancel
   - Verify current puzzle remains (entry still there)
   - Click "New Puzzle" again
   - Verify confirmation appears again
   - Click OK
   - Verify new puzzle generates

3. **Partial Puzzle (Warning Expected):**
   - Fill in 10-15 cells
   - Click "New Puzzle"
   - Verify confirmation appears
   - Click Cancel
   - Verify all entries remain
   - Click "New Puzzle"
   - Click OK
   - Verify new puzzle generates

4. **Complete Correct Puzzle (No Warning Expected):**
   - Solve a puzzle completely (all cells filled, no errors)
   - Click "Check Solution" - verify "Congratulations" message
   - Click "New Puzzle"
   - Verify NO confirmation dialog
   - Verify new puzzle generates immediately

5. **Complete Incorrect Puzzle (Warning Expected):**
   - Fill all cells but with errors
   - Click "New Puzzle"
   - Verify confirmation appears (puzzle is complete but may represent work in progress)
   - Test both Cancel and OK paths

**Alternative: Complete Incorrect = No Warning**
   - If we want completed (even incorrect) puzzles to skip warning:
     - Change logic to: `hasUserEntries && !state.isGridComplete()`
     - This means ANY complete grid skips warning
     - Decision: Product Owner to clarify requirement

6. **Edge Cases:**
   - Clear all user entries (delete everything entered)
   - Click "New Puzzle"
   - Verify NO confirmation (back to empty state)

7. **Mobile Testing:**
   - Test confirmation dialog on iOS Safari
   - Test confirmation dialog on Android Chrome
   - Verify dialog is readable and buttons tappable
   - Verify Cancel and OK work correctly

8. **Rapid Clicking:**
   - Start puzzle, add entries
   - Click "New Puzzle" rapidly multiple times
   - Verify confirmation appears once
   - Verify no duplicate confirmations or race conditions

**Expected Behaviors:**
- Confirmation appears only when user has made entries
- Confirmation prevents accidental loss of progress
- Cancel returns to current puzzle without changes
- OK generates new puzzle as expected

**Pass Criteria:**
- Empty puzzles skip confirmation
- In-progress puzzles show confirmation
- Complete puzzles skip confirmation (or show confirmation if decided)
- Cancel works correctly (keeps puzzle)
- OK works correctly (generates new puzzle)
- No console errors
- Works on desktop and mobile

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-10-30 | 1.0 | Confirmation warning story created for mobile UX enhancement | Product Owner Sarah |

## Dev Agent Record

*(To be filled by Dev agent during implementation)*

## QA Results

*(To be filled by QA agent after implementation)*
